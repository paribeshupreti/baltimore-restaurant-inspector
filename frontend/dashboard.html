<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Scraper Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --transition-color: #ffc107;
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .last-updated {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-bar {
            flex: 1;
            min-width: 250px;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .filter-btn.active {
            background-color: var(--info-color);
            color: white;
            border-color: var(--info-color);
        }

        .toggle-dark-mode {
            padding: 8px 16px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--bg-primary);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background-color: var(--border-color);
        }

        tr:hover {
            background-color: var(--bg-primary);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-success {
            background-color: var(--success-color);
            color: white;
        }

        .status-error {
            background-color: var(--error-color);
            color: white;
        }

        .status-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .status-transition {
            background-color: var(--transition-color);
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #c62828;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background-color: var(--bg-primary);
            border-radius: 5px;
        }

        .timeline-item {
            display: flex;
            padding: 12px 0;
            border-left: 3px solid var(--border-color);
            padding-left: 20px;
            margin-bottom: 10px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 18px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--info-color);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-time {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .refresh-btn {
            padding: 8px 16px;
            background-color: var(--info-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .refresh-btn:hover {
            background-color: #1976d2;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 8px;
            }
        }

        .sort-indicator {
            margin-left: 5px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçΩÔ∏è Restaurant Scraper Analytics Dashboard</h1>
            <p class="last-updated" id="lastUpdated">Loading...</p>
        </header>

        <div class="controls">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search restaurants..." />
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="successfully_scraped">Success</button>
                <button class="filter-btn" data-filter="not_found">Not Found</button>
                <button class="filter-btn" data-filter="scraping_failed">Failed</button>
                <button class="filter-btn" data-filter="previously_failed_now_success">Recovered</button>
            </div>
            <button class="refresh-btn" onclick="loadAnalytics()">üîÑ Refresh</button>
            <button class="toggle-dark-mode" onclick="toggleDarkMode()">üåì Dark Mode</button>
        </div>

        <div id="content">
            <div class="loading">Loading analytics data...</div>
        </div>
    </div>

    <script>
        let analyticsData = null;
        let restaurantData = [];
        let currentFilter = 'all';
        let currentSort = { column: 'search_count', direction: 'desc' };

        // Load analytics on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadAnalytics();
            // Auto-refresh every 30 seconds
            setInterval(loadAnalytics, 30000);
        });

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('../data/analytics.json');
                if (!response.ok) {
                    throw new Error('Analytics file not found');
                }
                analyticsData = await response.json();
                renderDashboard();
            } catch (error) {
                renderError(error);
            }
        }

        function renderError(error) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="error-message">
                    <h3>Error Loading Analytics</h3>
                    <p>${error.message}</p>
                    <p>Make sure analytics.json exists and the dashboard is served via HTTP (not file://).</p>
                    <p>Run: <code>python3 -m http.server 8000</code> then open <code>http://localhost:8000/dashboard.html</code></p>
                </div>
            `;
        }

        function renderDashboard() {
            if (!analyticsData) return;

            const content = document.getElementById('content');
            const metadata = analyticsData.metadata;
            const restaurants = analyticsData.restaurant_searches;

            // Update last updated time
            document.getElementById('lastUpdated').textContent =
                `Last Updated: ${new Date(metadata.last_updated).toLocaleString()}`;

            // Calculate stats
            const totalRestaurants = Object.keys(restaurants).length;
            const successfulRestaurants = Object.values(restaurants).filter(r =>
                r.status === 'successfully_scraped' || r.status === 'previously_failed_now_success'
            ).length;
            const successRate = totalRestaurants > 0
                ? ((successfulRestaurants / totalRestaurants) * 100).toFixed(1)
                : 0;

            content.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${metadata.total_searches}</div>
                        <div class="stat-label">Total Searches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${metadata.total_sessions}</div>
                        <div class="stat-label">Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalRestaurants}</div>
                        <div class="stat-label">Unique Restaurants</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${successRate}%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">üìä All Searched Restaurants</div>
                    <div id="restaurantTable"></div>
                </div>

                <div class="section">
                    <div class="section-title">üî• High-Demand Restaurants NOT in Database</div>
                    <div id="demandTable"></div>
                </div>

                <div class="section">
                    <div class="section-title">üìà Status Breakdown</div>
                    <div id="statusChart"></div>
                </div>
            `;

            renderRestaurantTable();
            renderDemandTable();
            renderStatusChart();
        }

        function renderRestaurantTable() {
            const restaurants = analyticsData.restaurant_searches;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = Object.entries(restaurants)
                .map(([name, data]) => ({ name, ...data }))
                .filter(r => {
                    const matchesSearch = r.name.toLowerCase().includes(searchTerm);
                    const matchesFilter = currentFilter === 'all' || r.status === currentFilter;
                    return matchesSearch && matchesFilter;
                });

            // Sort
            filtered.sort((a, b) => {
                const aVal = a[currentSort.column];
                const bVal = b[currentSort.column];
                const direction = currentSort.direction === 'asc' ? 1 : -1;

                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return (aVal - bVal) * direction;
                }
                return String(aVal).localeCompare(String(bVal)) * direction;
            });

            if (filtered.length === 0) {
                document.getElementById('restaurantTable').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No restaurants found</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th onclick="sortTable('name')">
                                Restaurant Name ${getSortIndicator('name')}
                            </th>
                            <th onclick="sortTable('star_rating')">
                                Rating ${getSortIndicator('star_rating')}
                            </th>
                            <th onclick="sortTable('violations_count')">
                                Violations ${getSortIndicator('violations_count')}
                            </th>
                            <th>
                                Severity Breakdown
                            </th>
                            <th onclick="sortTable('search_count')">
                                Searches ${getSortIndicator('search_count')}
                            </th>
                            <th onclick="sortTable('status')">
                                Status ${getSortIndicator('status')}
                            </th>
                            <th onclick="sortTable('last_searched')">
                                Last Searched ${getSortIndicator('last_searched')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map((r, index) => `
                            <tr>
                                <td style="color: var(--text-secondary); font-weight: bold;">${index + 1}</td>
                                <td><strong>${r.name}</strong></td>
                                <td>${getStarRatingDisplay(r.star_rating)}</td>
                                <td>${getViolationsDisplay(r.violations_count)}</td>
                                <td>${getSeverityBreakdown(r.severity_breakdown)}</td>
                                <td>${r.search_count}</td>
                                <td>${getStatusBadge(r.status)}</td>
                                <td>${r.last_searched ? new Date(r.last_searched).toLocaleString() : 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('restaurantTable').innerHTML = tableHTML;
        }

        function renderDemandTable() {
            const demand = analyticsData.demand_analysis.not_found_restaurants;

            if (demand.length === 0) {
                document.getElementById('demandTable').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <p>All searched restaurants are in the database!</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Restaurant Name</th>
                            <th>Search Count</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${demand.map(r => `
                            <tr>
                                <td><strong>${r.name}</strong></td>
                                <td>${r.search_count}</td>
                                <td>
                                    <span style="color: var(--warning-color);">
                                        ‚ö†Ô∏è Consider adding to scraping list
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('demandTable').innerHTML = tableHTML;
        }

        function renderStatusChart() {
            const restaurants = Object.values(analyticsData.restaurant_searches);
            const statusCounts = {
                'successfully_scraped': 0,
                'not_found': 0,
                'scraping_failed': 0,
                'previously_failed_now_success': 0,
                'unknown': 0
            };

            restaurants.forEach(r => {
                statusCounts[r.status] = (statusCounts[r.status] || 0) + 1;
            });

            const total = restaurants.length;
            const chartHTML = `
                <div class="chart-container">
                    ${Object.entries(statusCounts)
                        .filter(([_, count]) => count > 0)
                        .map(([status, count]) => {
                            const percentage = ((count / total) * 100).toFixed(1);
                            return `
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>${getStatusLabel(status)}</span>
                                        <span><strong>${count}</strong> (${percentage}%)</span>
                                    </div>
                                    <div style="background-color: var(--border-color); height: 30px; border-radius: 5px; overflow: hidden;">
                                        <div style="
                                            width: ${percentage}%;
                                            height: 100%;
                                            background-color: ${getStatusColor(status)};
                                            transition: width 0.5s;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            font-weight: bold;
                                        ">
                                            ${percentage > 5 ? percentage + '%' : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                </div>
            `;

            document.getElementById('statusChart').innerHTML = chartHTML;
        }

        function getStatusBadge(status) {
            const badges = {
                'successfully_scraped': '<span class="status-badge status-success">‚úì Success</span>',
                'not_found': '<span class="status-badge status-error">‚úó Not Found</span>',
                'scraping_failed': '<span class="status-badge status-warning">‚ö† Failed</span>',
                'previously_failed_now_success': '<span class="status-badge status-transition">‚Üó Recovered</span>',
                'unknown': '<span class="status-badge">? Unknown</span>'
            };
            return badges[status] || badges['unknown'];
        }

        function getStatusLabel(status) {
            const labels = {
                'successfully_scraped': 'Successfully Scraped',
                'not_found': 'Not Found in Portal',
                'scraping_failed': 'Scraping Failed',
                'previously_failed_now_success': 'Previously Failed, Now Success',
                'unknown': 'Unknown'
            };
            return labels[status] || status;
        }

        function getStatusColor(status) {
            const colors = {
                'successfully_scraped': 'var(--success-color)',
                'not_found': 'var(--error-color)',
                'scraping_failed': 'var(--warning-color)',
                'previously_failed_now_success': 'var(--transition-color)',
                'unknown': 'var(--text-secondary)'
            };
            return colors[status] || colors['unknown'];
        }

        function getStarRatingDisplay(rating) {
            if (rating === undefined || rating === null) {
                return '<span style="color: var(--text-secondary);">N/A</span>';
            }
            const stars = '‚≠ê'.repeat(rating);
            return `<span style="font-size: 1.1rem;">${stars}</span> <strong>${rating}</strong>`;
        }

        function getViolationsDisplay(count) {
            if (count === undefined || count === null) {
                return '<span style="color: var(--text-secondary);">N/A</span>';
            }
            if (count === 0) {
                return '<span style="color: var(--success-color); font-weight: bold;">‚úì 0</span>';
            }
            const color = count >= 4 ? 'var(--error-color)' : count >= 2 ? 'var(--warning-color)' : 'var(--info-color)';
            return `<span style="color: ${color}; font-weight: bold;">${count}</span>`;
        }

        function getSeverityBreakdown(breakdown) {
            if (!breakdown) {
                return '<span style="color: var(--text-secondary); font-size: 0.85rem;">N/A</span>';
            }

            const badges = [];
            if (breakdown.SEVERE > 0) {
                badges.push(`<span class="status-badge status-error">${breakdown.SEVERE} Severe</span>`);
            }
            if (breakdown.MAJOR > 0) {
                badges.push(`<span class="status-badge status-warning">${breakdown.MAJOR} Major</span>`);
            }
            if (breakdown.MODERATE > 0) {
                badges.push(`<span class="status-badge status-transition">${breakdown.MODERATE} Moderate</span>`);
            }
            if (breakdown.MINOR > 0) {
                badges.push(`<span class="status-badge status-success">${breakdown.MINOR} Minor</span>`);
            }
            if (breakdown.UNKNOWN_MODERATE > 0) {
                badges.push(`<span class="status-badge">${breakdown.UNKNOWN_MODERATE} Unknown</span>`);
            }

            return badges.length > 0 ? badges.join(' ') : '<span style="color: var(--text-secondary); font-size: 0.85rem;">None</span>';
        }

        function getSortIndicator(column) {
            if (currentSort.column === column) {
                return `<span class="sort-indicator">${currentSort.direction === 'asc' ? '‚Üë' : '‚Üì'}</span>`;
            }
            return '';
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            renderRestaurantTable();
        }

        // Search functionality
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').addEventListener('input', () => {
                renderRestaurantTable();
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    renderRestaurantTable();
                });
            });
        });
    </script>
</body>
</html>
